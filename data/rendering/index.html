<!DOCTYPE html>
<html>
  <head>
    <title>Graphs and plots</title>
    <!-- <link rel="stylesheet" href="chartist-js/dist/chartist.min.css"> -->
    <link rel="stylesheet" href="style.css">
    <meta charset="utf-8" />

<style>

/*body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  width: 960px;
  height: 500px;
  position: relative;
}*/

svg {
  width: 100%;
  height: 500px;
}

path.slice{
  stroke-width:1px;
}

polyline{
  stroke: black;
  stroke-width: 1px;
  fill: none;
}

</style>


  </head>
  <body id='body'>

  <div id='charts'></div>

    <ul>
      <li class='Javascript'>Javascript</li>
      <li class='C'>C</li>
      <li class='Cplusplus'>C++</li>
      <li class='Java'>Java</li>
      <li class='PHP'>PHP</li>
      <li class='XML_Schema'>XML Schema</li>
      <li class='Ruby'>Ruby</li>
      <li class='Autoconf'>Autoconf</li>
      <li class='Python'>Python</li>
      <li class='Csharp'>C#</li>
      <li class='Assembler'>Assembler</li>
      <li class='Shell'>Shell</li>
      <li class='SQL'>SQL</li>
      <li class='Make'>Make</li>
      <li class='Perl'>Perl</li>
    </ul>

    <!-- <div class="chart3 ct-major-twelfth eighty"></div> --><!--
 --><ul>
      <li class = 'npm'>npm (node.js)</li>
      <li class = 'Bower'>Bower (JS)</li>
      <!--<li class = 'Clojars'>Clojars (Clojure)</li>-->
      <!--<li class = 'CPAN'>CPAN</li>-->
      <!--<li class = 'CPANsearch'>CPAN (search)</li>-->
      <!--<li class = 'CRAN'>CRAN (R)</li>-->
      <!--<li class = 'Crates'>Crates.io (Rust)</li>-->
      <!--<li class = 'GoDoc'>GoDoc (Go)</li>-->
      <!--<li class = 'Hackage'>Hackage (Haskell)</li>-->
      <!--<li class = 'Hex'>Hex.pm (Elixir/Erlang)</li>-->
      <!--<li class = 'LuaRocks'>LuaRocks (Lua)</li>-->
      <li class = 'Maven'>Maven Central (Java)</li>
      <!--<li class = 'MELPA'>MELPA (Emacs)</li>-->
      <li class = 'nuget'>nuget (.NET)</li>
      <li class = 'Packagist'>Packagist (PHP)</li>
      <li class = 'Pear'>Pear (PHP)</li>
      <li class = 'PyPI'>PyPI</li>
      <li class = 'Rubygems'>Rubygems.org</li>
    </ul>

    <script src="bower_components/d3/d3.min.js"></script>
<!--     <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="chartist-js/dist/chartist.js"></script> -->
    <!-- <script src="jsPDF/dist/jspdf.debug.js"></script> -->
<!--     <script src="tiobe.js"></script>
    <script src="charts.js"></script> -->



<script>

function type(d) {
  d.percentage = +d.percentage;
  return d;
}

function key(d) {
  return d.data.label;
};

function cleanse(label) {
  return label.replace(/[+]/g, 'plus')
              .replace(/ /g, '_')
              .replace(/[#]/g, 'sharp')
              .replace(/[()./]/g, '');
}

function threshold(d) {
  return d.value > 1.6;
}

d3.csv('csv/blackduck-alltime.csv', type, onReady(piechart));
// d3.csv('csv/blackduck-alltime.csv', type, piechart);
// d3.csv('csv/blackduck-2015.csv', type, piechart);
// d3.csv('csv/stackoverflow-mostwanted.csv', type, piechart);
// d3.csv('csv/modulecounts.csv', type, linechartFactory(d3.time.format('%Y\/%m\/%d').parse));
// d3.csv('csv/stackoverflow-tags.csv', type, linechartFactory(d3.time.format('%Y%m').parse));
// d3.csv('csv/tiobe.csv', type, linechartFactory(d3.time.format('%Y%m%d').parse));

var count = 1;

function onReady(cb) {
  return function()Â {
    cb.apply(this, arguments);

    if (--count === 0) {

      console.log('ready');
      var XMLS = new XMLSerializer();

      var SVG = charts.getElementsByTagName('svg');

      for (var i = 0; i < SVG.length; i++) { 
          console.log(i);
          console.log(SVG[i]);

          var svg = XMLS.serializeToString(SVG[i]); // First convert DOM node into a string
          console.log(svg);

      }
    }
  }
}

// var svgArray = Array.prototype.slice.call(svg);

// console.log(charts.children[0]);


// console.log(svgArray);

// var e = svgArray[0];

// svgArray.forEach(function(e) {
  // var svg = XMLS.serializeToString(e); // First convert DOM node into a string
  // console.log(svg);
// })

// console.log(svgArray);


function piechart(error, data) {
  if (error) throw error;


  var svg = d3.select('#charts')
    .append('svg')
    .append('g');

  svg.attr('class', 'chart');

  svg.append('g')
    .attr('class', 'slices');
  svg.append('g')
    .attr('class', 'labels');
  svg.append('g')
    .attr('class', 'lines');

  var width = 960,
      height = 450,
    radius = Math.min(width, height) / 2;

  var pie = d3.layout.pie()
    .sort(null)
    .value(function(d) {
      return d.value;
    });

  var arc = d3.svg.arc()
    .outerRadius(radius * 0.8)
    .innerRadius(radius * 0.4);

  var outerArc = d3.svg.arc()
    .innerRadius(radius * 0.9)
    .outerRadius(radius * 0.9);

  svg.attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')');

//  change(randomData());

  // console.log(randomData());

  var fdata = data.map(function(row){
    return { label: row.language, value: row.percentage }
  })

  change(fdata);


// d3.select('.randomize')
//   .on('click', function(){
//     change(randomData());
//   });


  function change(data) {


    // console.log(data, svg);  

    /* ------- PIE SLICES -------*/
    var slice = svg.select('.slices').selectAll('path.slice')
      .data(pie(data), key);

    slice.enter()
      .insert('path')
      .attr('class', function(d) { return 'slice ' + cleanse(d.data.label) })
      .attr('d', function(d) {arc(d)})

      // .attrTween('d', function(d) {
      //   this._current = this._current || d;
      //   var interpolate = d3.interpolate(this._current, d);
      //   this._current = interpolate(0);
      //   return function(t) {
      //     return arc(interpolate(t));
      //   };
      // })

    // slice.exit()
    //   .remove();

    // /* ------- TEXT LABELS -------*/

    var text = svg.select('.labels').selectAll('text')
      .data(pie(data), key);

    text.enter()
      .append('text')
      .filter(threshold)
      .attr('dy', '.35em')
      .text(function(d) {
        return d.data.label;
      });
    
    function midAngle(d){
      return d.startAngle + (d.endAngle - d.startAngle)/2;
    }

    text.transition().duration(1000)
      .attrTween('transform', function(d) {
        this._current = this._current || d;
        var interpolate = d3.interpolate(this._current, d);
        this._current = interpolate(0);
        return function(t) {
          var d2 = interpolate(t);
          var pos = outerArc.centroid(d2);
          pos[0] = radius * (midAngle(d2) < Math.PI ? 1 : -1);
          return 'translate('+ pos +')';
        };
      })
      .styleTween('text-anchor', function(d){
        this._current = this._current || d;
        var interpolate = d3.interpolate(this._current, d);
        this._current = interpolate(0);
        return function(t) {
          var d2 = interpolate(t);
          return midAngle(d2) < Math.PI ? 'start':'end';
        };
      });

    // text.exit()
    //   .remove();

    // /* ------- SLICE TO TEXT POLYLINES -------*/

    var polyline = svg.select('.lines').selectAll('polyline')
      .data(pie(data), key);
    
    polyline.enter()
      .append('polyline')
      .filter(threshold)
      .attr('class', function(d) { return 'line ' + cleanse(d.data.label) });

    polyline.transition().duration(1000)
      .filter(threshold)
      .attrTween('points', function(d){
        this._current = this._current || d;
        var interpolate = d3.interpolate(this._current, d);
        this._current = interpolate(0);
        return function(t) {
          var d2 = interpolate(t);
          var pos = outerArc.centroid(d2);
          pos[0] = radius * 0.95 * (midAngle(d2) < Math.PI ? 1 : -1);
          return [arc.centroid(d2), outerArc.centroid(d2), pos];
        };      
      });
    
    polyline.exit()
      .remove();
  };

}


function linechartFactory(parseDate) {

  return function linechart(error, data) {

    var margin = {top: 20, right: 80, bottom: 30, left: 100},
        width = 960 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;


    // var parseDate = d3.time.format('%Y\/%m\/%d').parse;

    var x = d3.time.scale()
        .range([0, width]);

    var y = d3.scale.linear()
        .range([height, 0]);

    var color = d3.scale.category10();

    var xAxis = d3.svg.axis()
        .scale(x)
        .orient('bottom')
        .ticks(5);

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient('left')
        .ticks(5);
        
    var yTicks = d3.svg.axis()
        .scale(y)
        .orient('left')
        .ticks(5)
        .tickSize(-width, 0, 0)
        .tickFormat('');


    var line = d3.svg.line()
        .defined(function(d) { return (d.count !== 0) })
        .interpolate('basis')
        .x(function(d) { return x(d.date); })
        .y(function(d) { return y(d.count); });

    var svg = d3.select('#charts').append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .attr('class', 'chart')
      .append('g')
        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

    // var fdata = data.map(function(row){
    //   return { label: row.language, value: row.percentage }
    // })

    init(data);

    function init(data) {
      if (error) throw error;

      color.domain(d3.keys(data[0]).filter(function(key) { return key !== 'date'; }));

      data.forEach(function(d) {
        // console.log(d);
        d.date = parseDate(d.date);
      });

      var managers = color.domain().map(function(name) {
        return {
          name: name,
          values: data.map(function(d) {
            return {date: d.date, count: +d[name], manager: name};
          })
        };
      });


      x.domain(d3.extent(data, function(d) { return d.date; }));

      y.domain([
        d3.min(managers, function(c) { return d3.min(c.values, function(v) { return v.count; }); }),
        d3.max(managers, function(c) { return d3.max(c.values, function(v) { return v.count; }); })
      ]);

      svg.append('g')
          .attr('class', 'x axis')
          .attr('transform', 'translate(0,' + height + ')')
          .call(xAxis);

      svg.append('g')
          .attr('class', 'y axis')
          .call(yAxis)
        .append('text')
          .attr('transform', 'rotate(-90)')
          .attr('y', 6)
          .attr('dy', '.71em')
          .style('text-anchor', 'end')
          .text('count');

      var managers = svg.selectAll('.manager')
          .data(managers)
        .enter().append('g')
          .attr('class', 'manager');

      managers.append('path')
          .attr('class', function(d) { return 'line ' + cleanse(d.name) })
          .attr('d', function(d) { return line(d.values); });
          // .style('stroke', function(d) { return color(d.name); });

      // managers.append('text')
      //     .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; })
      //     .attr('transform', function(d) { return 'translate(' + x(d.value.date) + ',' + y(d.value.temperature) + ')'; })
      //     .attr('x', 3)
      //     .attr('dy', '.35em')
      //     .text(function(d) { return d.name; });
    };

  }

}
</script>


  </body>
</html>